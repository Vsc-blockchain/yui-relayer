#!/bin/bash

set -eux

source $(cd $(dirname "$0"); pwd)/../../../scripts/util

SCRIPT_DIR=$(cd $(dirname $0); pwd)
RELAYER_CONF="$HOME/.yui-relayer"
RLY_BINARY=${SCRIPT_DIR}/../../../../build/yrly
RLY="${RLY_BINARY} --debug"

CHAINID_ONE=ibc0
CHAINID_TWO=ibc1
RLYKEY=testkey
PATH_NAME=ibc01

# back up the original connection identifiers
srcOrigConnectionId=$($RLY paths list --json | jq --raw-output --arg path_name "$PATH_NAME" '.[$path_name].src."connection-id"')
dstOrigConnectionId=$($RLY paths list --json | jq --raw-output --arg path_name "$PATH_NAME" '.[$path_name].dst."connection-id"')

# back up the original config.json and make connection identifiers empty
origconfig=`mktemp`
cp "$RELAYER_CONF/config/config.json" $origconfig
$RLY paths edit $PATH_NAME src connection-id ''
$RLY paths edit $PATH_NAME dst connection-id ''

# create a new connection and save the new connection identifiers
retry 5 $RLY tx connection $PATH_NAME
srcAltConnectionId=$($RLY paths list --json | jq --raw-output --arg path_name "$PATH_NAME" '.[$path_name].src."connection-id"')
dstAltConnectionId=$($RLY paths list --json | jq --raw-output --arg path_name "$PATH_NAME" '.[$path_name].dst."connection-id"')

# resume the original config.json
mv $origconfig "$RELAYER_CONF/config/config.json"

checkResult() {
    expectedSrcConnectionId=$1
    expectedDstConnectionId=$2
    pathSrcConnectionId=$($RLY paths list --json | jq --raw-output --arg path_name "$PATH_NAME" '.[$path_name].src."connection-id"')
    pathDstConnectionId=$($RLY paths list --json | jq --raw-output --arg path_name "$PATH_NAME" '.[$path_name].dst."connection-id"')
    if [ "$pathSrcConnectionId" != "$expectedSrcConnectionId" ]
    then
	echo 'src path config update failed'
	exit 1
    elif [ "$pathDstConnectionId" != "$expectedDstConnectionId" ]
    then
	echo 'dst path config update failed'
	exit 1
    fi
}

# test channel upgrade (crossing-hello)
$RLY tx channel-upgrade init ibc01 ibc0 --ordering unordered --connection-hops $srcAltConnectionId --version ics20-1
$RLY tx channel-upgrade init ibc01 ibc1 --ordering UnOrdered --connection-hops $dstAltConnectionId --version ics20-1
$RLY tx channel-upgrade execute ibc01
checkResult "$srcAltConnectionId" "$dstAltConnectionId"

# test channel upgrade (non-crossing-hello)
$RLY tx channel-upgrade init ibc01 ibc0 --ordering UNORDERED --connection-hops $srcOrigConnectionId --version ics20-1
$RLY tx channel-upgrade init ibc01 ibc0 --ordering UNORDERED --connection-hops $srcOrigConnectionId --version ics20-1
$RLY tx channel-upgrade init ibc01 ibc1 --ordering UNORDERED --connection-hops $dstOrigConnectionId --version ics20-1
$RLY tx channel-upgrade execute ibc01
checkResult "$srcOrigConnectionId" "$dstOrigConnectionId"

# test channel upgrade cancel
$RLY tx channel-upgrade init ibc01 ibc0 --ordering UNORDERED --connection-hops $srcAltConnectionId --version ics20-1
$RLY tx channel-upgrade init ibc01 ibc1 --ordering UNORDERED --connection-hops $dstAltConnectionId --version ics20-1
$RLY tx channel-upgrade cancel ibc01 ibc0  # create situation where ibc0.error_receipt.sequence >= ibc1.channel.upgrade_sequence
$RLY tx channel-upgrade execute ibc01      # the channel upgrade of ibc1 should be cancelled
checkResult "$srcOrigConnectionId" "$dstOrigConnectionId"

